import { type ColumnDef, type CellContext } from '@tanstack/react-table';
import { Badge } from '@/components/ui/badge';
import { SeverityBadge } from '@/components/SeverityBadge';
import { StatusBadge } from '@/components/StatusBadge';
import { Button } from '@/components/ui/button';
import { Link } from 'react-router-dom';
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog';
import { useNavigate } from 'react-router-dom';
import type { Vulnerability } from '@/types';

interface Options {
  onDelete: (id: number) => void;
}

export function useVulnerabilityColumns({ onDelete }: Options): ColumnDef<Vulnerability>[] {
  const navigate = useNavigate();
  return [
    { accessorKey: 'name', header: 'Name', cell: ({ row }: CellContext<Vulnerability, unknown>) => {
        const v = row.original;
        return <Link to={`/vulnerabilities/${v.id}`} className="text-blue-600 hover:underline">{v.name}</Link>;
      } },
    { accessorKey: 'description', header: 'Description' },
  { accessorKey: 'severity', header: 'Severity', cell: ({ row }: CellContext<Vulnerability, unknown>) => {
        const severity = row.getValue('severity') as string;
        return <SeverityBadge severity={severity} />;
      }
    },
  { accessorKey: 'status', header: 'Status', cell: ({ row }: CellContext<Vulnerability, unknown>) => {
        const status = row.getValue('status') as string;
        return <StatusBadge status={status} />;
      }
    },
  { accessorKey: 'reported_at', header: 'Reported At', cell: ({ row }: CellContext<Vulnerability, unknown>) => {
        const date = new Date(row.getValue('reported_at') as string);
        return date.toLocaleString();
      }
    },
  { id: 'actions', cell: ({ row }: CellContext<Vulnerability, unknown>) => {
        const vulnerability = row.original;
        return (
          <div className="space-x-2">
            <Button variant="secondary" size="sm" onClick={() => navigate(`/vulnerabilities/${vulnerability.id}`)}>Open</Button>
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button variant="destructive" size="sm">Delete</Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Are you sure?</AlertDialogTitle>
                  <AlertDialogDescription>This action cannot be undone. This will permanently delete the vulnerability.</AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancel</AlertDialogCancel>
                  <AlertDialogAction onClick={() => onDelete(vulnerability.id)}>Delete</AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          </div>
        );
      }
    },
  ];
}
